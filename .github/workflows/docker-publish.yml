name: Build and Publish docker image

on:
  workflow_dispatch:
    inputs:
      vincrement:
        description: 'Package version increment (major.feature.bug)'
        required: true
        default: 'bug'
        type: choice
        options:
          - major
          - feature
          - bug

env:
  REGISTRY_IMAGE: ghcr.io/calaos/calaos_base
  NAME: calaos_base
  CALAOS_REL_URL: https://releases.calaos.fr/v4/image
  IMG_TAG: latest

jobs:
  # define job to build and publish docker image
  build-and-push-docker-image:
    name: Build Docker image and push to repositories
    # run only when code is compiling and tests are passing
    runs-on: ubuntu-latest

    # steps to perform in job
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch latest release version
        id: fetch-latest-release
        uses: reloc8/action-latest-release-version@1.0.1

      - name: Increment dev release version
        id: bump_version
        uses: actionsdesk/semver@0.6.0-rc.10
        with:
          prerelease: withBuildNumber
          prelabel: alpha
          initial_version: ${{ steps.fetch-latest-release.outputs.latest-release }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY_IMAGE }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Github Packages
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          build-args: APP_VERSION=${{ steps.bump_version.outputs.release }}
          tags: |
            ${{ env.REGISTRY_IMAGE }}:${{ env.IMG_TAG }}
            ${{ env.REGISTRY_IMAGE }}:${{ steps.bump_version.outputs.release }}

      - name: Create Tag
        uses: negz/create-tag@v1
        with:
          version: ${{ steps.bump_version.outputs.release }}
          token: ${{ secrets.ACTION_DISPATCH }}

      - name: Build deb
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.ACTION_DISPATCH }}
          repository: calaos/pkgdebs
          event-type: build_deb
          client-payload: '{ "pkgname": "calaos-server", "version": "${{ steps.bump_version.outputs.release }}", "image_src": "${{ env.REGISTRY_IMAGE }}:${{ steps.bump_version.outputs.release }}", "prerelease": false }'
  
